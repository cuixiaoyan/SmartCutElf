# 临时文件问题修复说明

## 🐛 问题描述

**错误信息：**
```
音频加载失败: [Errno 2] No such file or directory: 'D:\\上传资料测试\\shipin\\old\\temp_audio.wav'
计算音频分数失败: [Errno 2] No such file or directory: 'D:\\上传资料测试\\shipin\\old\\temp_audio.wav'
```

**问题原因：**
1. 临时音频文件被保存在视频文件所在的目录
2. 可能存在权限问题（无法在该目录创建文件）
3. 路径中包含中文字符可能导致问题
4. 多个视频同时处理时文件名冲突

## ✅ 修复方案

### 1. 使用系统临时目录

**修改前：**
```python
temp_audio_path = Path(video_path).parent / "temp_audio.wav"
```

**修改后：**
```python
temp_manager = get_temp_manager()
temp_audio_path = temp_manager.create_unique_temp_file(
    prefix=f"{video_name}_",
    suffix=".wav",
    subdir="temp_audio"
)
```

**优势：**
- ✅ 使用系统临时目录（通常有完整权限）
- ✅ 自动创建唯一文件名（避免冲突）
- ✅ 统一管理所有临时文件
- ✅ 支持自动清理

### 2. 新增临时文件管理器

**文件：** `src/utils/temp_file_manager.py`

**核心功能：**
- 创建和管理临时文件
- 生成唯一文件名
- 清理过期文件
- 统计临时文件占用

**使用示例：**
```python
from utils.temp_file_manager import get_temp_manager

# 获取管理器
manager = get_temp_manager()

# 创建临时文件
temp_file = manager.create_unique_temp_file(
    prefix="video_",
    suffix=".wav",
    subdir="temp_audio"
)

# 清理旧文件（超过24小时）
manager.clean_temp_files(older_than_hours=24)

# 查看临时文件信息
print(manager.get_temp_info())
```

### 3. 改进错误处理

**使用 try-finally 确保清理：**
```python
try:
    # 处理逻辑
    segments = []
    # ...
    return segments
finally:
    # 确保清理临时文件
    if temp_audio_path.exists():
        temp_audio_path.unlink()
```

## 📂 临时文件位置

### Windows
```
C:\Users\{用户名}\AppData\Local\Temp\SmartCutElf\
├── temp_audio\          # 临时音频文件
├── temp_video\          # 临时视频文件
└── cache\               # 缓存文件
```

### Linux/Mac
```
/tmp/SmartCutElf/
├── temp_audio/
├── temp_video/
└── cache/
```

## 🔧 临时文件管理

### 手动清理

```python
from utils.temp_file_manager import get_temp_manager

manager = get_temp_manager()

# 清理所有临时文件
manager.clean_temp_files()

# 只清理音频临时文件
manager.clean_temp_files(subdir="temp_audio")

# 清理超过24小时的文件
manager.clean_temp_files(older_than_hours=24)
```

### 查看占用空间

```python
# 获取临时文件信息
info = manager.get_temp_info()
print(info)

# 输出示例：
# 📁 临时文件目录: C:\Users\...\Temp\SmartCutElf
# 📊 文件数量: 15
# 💾 占用空间: 245.67 MB
# 
# 子目录:
#   • temp_audio: 10 文件, 180.23 MB
#   • temp_video: 5 文件, 65.44 MB
```

### 自动清理

在应用启动时自动清理旧文件：

```python
# main.py
from utils.temp_file_manager import cleanup_old_temp_files

# 启动时清理超过24小时的临时文件
cleanup_old_temp_files(hours=24)
```

## 🎯 修复效果

### 修复前
- ❌ 临时文件保存在视频目录
- ❌ 可能遇到权限问题
- ❌ 文件名冲突
- ❌ 无法统一管理

### 修复后
- ✅ 使用系统临时目录
- ✅ 自动处理权限
- ✅ 唯一文件名
- ✅ 统一管理和清理

## 📝 使用建议

### 1. 定期清理

建议每周清理一次临时文件：

```python
# 清理超过7天的文件
manager.clean_temp_files(older_than_hours=7*24)
```

### 2. 监控空间

如果处理大量视频，定期检查临时文件占用：

```python
file_count, total_size = manager.get_temp_size()
size_mb = total_size / (1024 * 1024)

if size_mb > 1000:  # 超过1GB
    print(f"⚠️ 临时文件占用过大: {size_mb:.2f} MB")
    manager.clean_temp_files(older_than_hours=24)
```

### 3. 处理完成后清理

在批量处理完成后清理临时文件：

```python
def on_processing_finished(self, results):
    # 处理完成逻辑
    # ...
    
    # 清理临时文件
    from utils.temp_file_manager import get_temp_manager
    manager = get_temp_manager()
    manager.clean_temp_files(subdir="temp_audio")
```

## 🔍 故障排除

### 问题1: 仍然提示找不到文件

**可能原因：**
- FFmpeg 音频提取失败
- 磁盘空间不足
- 临时目录权限问题

**解决方案：**
1. 检查 FFmpeg 是否正确安装
2. 确认磁盘空间充足
3. 查看详细日志了解具体错误

### 问题2: 临时文件占用过大

**解决方案：**
```python
# 清理所有临时文件
manager.clean_temp_files()

# 或手动删除临时目录
import shutil
shutil.rmtree(manager.temp_root)
```

### 问题3: 无法创建临时文件

**可能原因：**
- 系统临时目录权限问题
- 磁盘已满

**解决方案：**
1. 检查系统临时目录权限
2. 清理磁盘空间
3. 手动指定临时目录

## 📚 相关文档

- [错误处理](docs/新功能说明.md#错误处理) - 友好的错误提示
- [性能优化](docs/新功能说明.md#性能优化) - 性能监控
- [使用说明](docs/使用说明.md) - 完整使用指南

## ✨ 总结

通过这次修复：
1. ✅ 解决了临时文件路径问题
2. ✅ 添加了统一的临时文件管理
3. ✅ 改进了错误处理
4. ✅ 支持自动清理
5. ✅ 提供了管理工具

现在临时文件管理更加可靠和易于维护！🎉

---

**修复时间：** 2024-11-20
**影响文件：**
- `src/core/highlight_detector.py` - 修改临时文件路径
- `src/utils/temp_file_manager.py` - 新增临时文件管理器
