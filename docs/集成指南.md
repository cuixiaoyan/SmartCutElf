# æ–°åŠŸèƒ½é›†æˆæŒ‡å—

æœ¬æ–‡æ¡£è¯´æ˜å¦‚ä½•åœ¨ç°æœ‰ä»£ç ä¸­é›†æˆæ–°å¢çš„ä¼˜åŒ–åŠŸèƒ½ã€‚

## ğŸ“¦ æ–°å¢æ¨¡å—

```
src/utils/
â”œâ”€â”€ error_handler.py      # é”™è¯¯å¤„ç†å’Œå‹å¥½æç¤º
â”œâ”€â”€ performance.py        # æ€§èƒ½ç›‘æ§å’Œä¼˜åŒ–
â”œâ”€â”€ notifications.py      # ç³»ç»Ÿé€šçŸ¥å’Œå¿«æ·æ“ä½œ
â”œâ”€â”€ config_presets.py     # é…ç½®é¢„è®¾ç®¡ç†
â””â”€â”€ debug_logger.py       # å¢å¼ºçš„æ—¥å¿—ç³»ç»Ÿ

src/ui/
â””â”€â”€ enhanced_widgets.py   # å¢å¼ºçš„UIç»„ä»¶
```

## ğŸ”§ é›†æˆæ­¥éª¤

### 1. åœ¨ä¸»çª—å£ä¸­é›†æˆé¢„è®¾é€‰æ‹©å™¨

```python
# src/ui/main_window.py

from ui.enhanced_widgets import PresetSelectorWidget, EnhancedProgressWidget, QuickActionsWidget
from utils.config_presets import PresetManager

class MainWindow(QMainWindow):
    def __init__(self):
        super().__init__()
        
        # æ·»åŠ é¢„è®¾é€‰æ‹©å™¨
        self.preset_selector = PresetSelectorWidget()
        self.preset_selector.preset_changed.connect(self._on_preset_changed)
        
        # æ·»åŠ åˆ°å·¦ä¾§é¢æ¿
        left_panel_layout.addWidget(self.preset_selector)
    
    def _on_preset_changed(self, preset_id: str):
        """é¢„è®¾æ”¹å˜æ—¶åº”ç”¨é…ç½®"""
        PresetManager.apply_preset(preset_id, self.config)
        self.add_status_message(f"âœ… å·²åˆ‡æ¢åˆ° {PresetManager.get_preset(preset_id).name}")
```

### 2. é›†æˆå¢å¼ºçš„è¿›åº¦æ˜¾ç¤º

```python
# æ›¿æ¢åŸæœ‰çš„è¿›åº¦ç»„ä»¶
class MainWindow(QMainWindow):
    def _create_right_panel(self):
        # ...
        
        # ä½¿ç”¨å¢å¼ºçš„è¿›åº¦ç»„ä»¶
        self.enhanced_progress = EnhancedProgressWidget()
        layout.addWidget(self.enhanced_progress)
    
    def on_processing_progress(self, current, total, message):
        """å¤„ç†è¿›åº¦æ›´æ–°"""
        self.enhanced_progress.update_progress(current, total, message)
    
    def start_processing(self):
        """å¼€å§‹å¤„ç†"""
        self.enhanced_progress.start_processing()
        # ... å…¶ä»–ä»£ç 
    
    def on_processing_finished(self, results):
        """å¤„ç†å®Œæˆ"""
        success_count = sum(1 for r in results if r.get('success'))
        self.enhanced_progress.finish_processing(success_count > 0)
        
        # å‘é€æ¡Œé¢é€šçŸ¥
        from utils.notifications import SystemNotifier
        SystemNotifier.notify(
            "SmartCutElf - å¤„ç†å®Œæˆ",
            f"æˆåŠŸå¤„ç† {success_count} ä¸ªè§†é¢‘æ–‡ä»¶",
            icon="info"
        )
```

### 3. æ·»åŠ å¿«æ·æ“ä½œæŒ‰é’®

```python
class MainWindow(QMainWindow):
    def _create_right_panel(self):
        # ...
        
        # æ·»åŠ å¿«æ·æ“ä½œ
        self.quick_actions = QuickActionsWidget()
        self.quick_actions.open_output_clicked.connect(self._open_output_folder)
        self.quick_actions.copy_log_clicked.connect(self._copy_log)
        self.quick_actions.export_log_clicked.connect(self._export_log)
        
        layout.addWidget(self.quick_actions)
    
    def _open_output_folder(self):
        """æ‰“å¼€è¾“å‡ºç›®å½•"""
        from utils.notifications import FileOperations
        output_dir = self.config.get('output.folder', 'output')
        if FileOperations.open_folder(output_dir):
            self.add_status_message(f"ğŸ“‚ å·²æ‰“å¼€è¾“å‡ºç›®å½•: {output_dir}")
        else:
            QMessageBox.warning(self, "é”™è¯¯", "æ— æ³•æ‰“å¼€è¾“å‡ºç›®å½•")
    
    def _copy_log(self):
        """å¤åˆ¶æ—¥å¿—åˆ°å‰ªè´´æ¿"""
        from utils.notifications import QuickActions
        log_text = self.status_text.toPlainText()
        if QuickActions.copy_to_clipboard(log_text):
            self.add_status_message("ğŸ“‹ æ—¥å¿—å·²å¤åˆ¶åˆ°å‰ªè´´æ¿")
    
    def _export_log(self):
        """å¯¼å‡ºæ—¥å¿—"""
        from utils.debug_logger import get_enhanced_logger
        logger = get_enhanced_logger()
        log_file = logger.export_log()
        self.add_status_message(f"ğŸ’¾ æ—¥å¿—å·²å¯¼å‡º: {log_file}")
        QMessageBox.information(self, "å¯¼å‡ºæˆåŠŸ", f"æ—¥å¿—å·²ä¿å­˜åˆ°:\n{log_file}")
```

### 4. é›†æˆé”™è¯¯å¤„ç†

```python
# src/core/workflow.py

from utils.error_handler import UserFriendlyError, ErrorCode, handle_exception

class VideoProcessingWorkflow:
    
    @handle_exception
    def process_video(self, video_path: str) -> Dict:
        """å¤„ç†å•ä¸ªè§†é¢‘"""
        
        # éªŒè¯æ–‡ä»¶
        from utils.error_handler import validate_file_path
        is_valid, error_code = validate_file_path(video_path)
        if not is_valid:
            raise UserFriendlyError(error_code, video_path)
        
        # è·å–è§†é¢‘ä¿¡æ¯
        try:
            video_info = self.video_processor.get_video_info(video_path)
        except FileNotFoundError:
            raise UserFriendlyError(
                ErrorCode.FFMPEG_NOT_FOUND,
                "è¯·å…ˆå®‰è£… FFmpeg å¹¶æ·»åŠ åˆ°ç³»ç»Ÿ PATH"
            )
        
        # ... å…¶ä»–å¤„ç†é€»è¾‘
```

### 5. åœ¨UIä¸­æ˜¾ç¤ºå‹å¥½é”™è¯¯

```python
# src/ui/main_window.py

from ui.enhanced_widgets import ErrorDialog
from utils.error_handler import UserFriendlyError

class MainWindow(QMainWindow):
    def on_processing_finished(self, results):
        """å¤„ç†å®Œæˆ"""
        # æ£€æŸ¥é”™è¯¯
        for result in results:
            if not result.get('success'):
                error = result.get('error', '')
                
                # å¦‚æœæ˜¯å‹å¥½é”™è¯¯ï¼Œæ˜¾ç¤ºé”™è¯¯å¯¹è¯æ¡†
                if isinstance(error, UserFriendlyError):
                    dialog = ErrorDialog(error.error_code, error.detail, self)
                    dialog.exec_()
                else:
                    # æ™®é€šé”™è¯¯
                    QMessageBox.warning(self, "å¤„ç†å¤±è´¥", str(error))
```

### 6. é›†æˆæ€§èƒ½ç›‘æ§

```python
# src/core/workflow.py

from utils.performance import MemoryMonitor, PerformanceOptimizer, PerformanceEstimator

class VideoProcessingWorkflow:
    def __init__(self):
        # ...
        self.memory_monitor = MemoryMonitor()
        self.optimizer = PerformanceOptimizer()
        self.estimator = PerformanceEstimator()
    
    def process_batch(self, video_paths: List[str], callback=None):
        """æ‰¹é‡å¤„ç†"""
        
        # è·å–æœ€ä¼˜å·¥ä½œçº¿ç¨‹æ•°
        max_workers = self.config.get('processing.max_workers', 4)
        optimal_workers = self.optimizer.get_optimal_workers(
            len(video_paths), 
            max_workers
        )
        
        self.logger.info(f"ä½¿ç”¨ {optimal_workers} ä¸ªå·¥ä½œçº¿ç¨‹")
        
        # å¤„ç†å‰æ£€æŸ¥å†…å­˜
        status, message = self.memory_monitor.check_memory_status()
        if status == 'critical':
            self.logger.warning(message)
        
        # é¢„ä¼°æ€»æ—¶é—´
        total_estimated = 0
        for path in video_paths:
            info = self.video_processor.get_video_info(path)
            if info:
                file_size = Path(path).stat().st_size / (1024 * 1024)
                estimated = self.estimator.estimate_time(file_size, info['duration'])
                total_estimated += estimated
        
        self.logger.info(f"é¢„ä¼°æ€»æ—¶é—´: {self.estimator.format_time(total_estimated)}")
        
        # ... å¤„ç†é€»è¾‘
```

### 7. é›†æˆå¢å¼ºæ—¥å¿—

```python
# src/core/workflow.py

from utils.debug_logger import get_enhanced_logger, LogMode

class VideoProcessingWorkflow:
    def __init__(self):
        # ä½¿ç”¨å¢å¼ºæ—¥å¿—å™¨
        self.logger = get_enhanced_logger("VideoProcessing", LogMode.USER)
    
    def process_video(self, video_path: str):
        """å¤„ç†è§†é¢‘"""
        
        # ç« èŠ‚åˆ†éš”
        self.logger.section(f"å¤„ç†è§†é¢‘: {Path(video_path).name}")
        
        # ç”¨æˆ·å‹å¥½çš„æ—¥å¿—
        self.logger.info(
            f"å¼€å§‹å¤„ç†: {video_path}",
            user_message="æ­£åœ¨åˆ†æè§†é¢‘..."
        )
        
        # è¿›åº¦æ—¥å¿—
        self.logger.progress(1, 5, "æå–éŸ³é¢‘")
        self.logger.progress(2, 5, "åˆ†æé«˜å…‰")
        self.logger.progress(3, 5, "ç”Ÿæˆå­—å¹•")
        self.logger.progress(4, 5, "åˆå¹¶ç‰‡æ®µ")
        self.logger.progress(5, 5, "è¾“å‡ºè§†é¢‘")
        
        # è­¦å‘Šå’Œé”™è¯¯
        self.logger.warning(
            "å†…å­˜ä½¿ç”¨ç‡: 85%",
            user_message="å†…å­˜ä½¿ç”¨è¾ƒé«˜ï¼Œå»ºè®®å…³é—­å…¶ä»–ç¨‹åº"
        )
```

## ğŸ¨ UI é›†æˆç¤ºä¾‹

### å®Œæ•´çš„ä¸»çª—å£å¸ƒå±€

```python
class MainWindow(QMainWindow):
    def _create_left_panel(self):
        """åˆ›å»ºå·¦ä¾§é¢æ¿"""
        panel = QWidget()
        layout = QVBoxLayout(panel)
        
        # 1. é¢„è®¾é€‰æ‹©å™¨
        self.preset_selector = PresetSelectorWidget()
        self.preset_selector.preset_changed.connect(self._on_preset_changed)
        layout.addWidget(self.preset_selector)
        
        # 2. æ“ä½œæŒ‰é’®ç»„
        buttons_group = QGroupBox("æ“ä½œ")
        buttons_layout = QVBoxLayout(buttons_group)
        
        self.btn_open = QPushButton('ğŸ“‚ æ‰“å¼€æ–‡ä»¶å¤¹')
        self.btn_start = QPushButton('â–¶ï¸ å¼€å§‹å¤„ç†')
        self.btn_stop = QPushButton('â¹ï¸ åœæ­¢å¤„ç†')
        
        buttons_layout.addWidget(self.btn_open)
        buttons_layout.addWidget(self.btn_start)
        buttons_layout.addWidget(self.btn_stop)
        
        layout.addWidget(buttons_group)
        
        # 3. æ–‡ä»¶åˆ—è¡¨
        files_group = QGroupBox("è§†é¢‘æ–‡ä»¶")
        files_layout = QVBoxLayout(files_group)
        
        self.file_list = QListWidget()
        files_layout.addWidget(self.file_list)
        
        layout.addWidget(files_group)
        
        return panel
    
    def _create_right_panel(self):
        """åˆ›å»ºå³ä¾§é¢æ¿"""
        panel = QWidget()
        layout = QVBoxLayout(panel)
        
        # 1. å¢å¼ºçš„è¿›åº¦æ˜¾ç¤º
        self.enhanced_progress = EnhancedProgressWidget()
        layout.addWidget(self.enhanced_progress)
        
        # 2. æ—¥å¿—æ˜¾ç¤º
        log_group = QGroupBox("å¤„ç†æ—¥å¿—")
        log_layout = QVBoxLayout(log_group)
        
        self.status_text = QTextEdit()
        self.status_text.setReadOnly(True)
        log_layout.addWidget(self.status_text)
        
        layout.addWidget(log_group)
        
        # 3. å¿«æ·æ“ä½œ
        self.quick_actions = QuickActionsWidget()
        self.quick_actions.open_output_clicked.connect(self._open_output_folder)
        self.quick_actions.copy_log_clicked.connect(self._copy_log)
        self.quick_actions.export_log_clicked.connect(self._export_log)
        layout.addWidget(self.quick_actions)
        
        return panel
```

## ğŸ“ é…ç½®æ–‡ä»¶æ›´æ–°

ç¡®ä¿ `config.yaml` åŒ…å«æ–°çš„é…ç½®é¡¹ï¼š

```yaml
# æ€§èƒ½è®¾ç½®
performance:
  memory_warning_threshold: 80.0
  memory_critical_threshold: 90.0
  enable_progress_cache: true
  enable_notifications: true

# æ—¥å¿—è®¾ç½®
logging:
  mode: user  # user æˆ– debug
  export_dir: logs/exports

# UIè®¾ç½®
ui:
  default_preset: balanced
  show_memory_monitor: true
  show_time_estimate: true
```

## ğŸ§ª æµ‹è¯•æ–°åŠŸèƒ½

åˆ›å»ºæµ‹è¯•è„šæœ¬éªŒè¯åŠŸèƒ½ï¼š

```python
# test_new_features.py

def test_error_handler():
    """æµ‹è¯•é”™è¯¯å¤„ç†"""
    from utils.error_handler import UserFriendlyError, ErrorCode
    
    try:
        raise UserFriendlyError(ErrorCode.FFMPEG_NOT_FOUND)
    except UserFriendlyError as e:
        print(e.message)
        print("Solutions:", e.get_solutions())

def test_performance():
    """æµ‹è¯•æ€§èƒ½ç›‘æ§"""
    from utils.performance import MemoryMonitor, PerformanceEstimator
    
    monitor = MemoryMonitor()
    print(monitor.get_memory_info_text())
    
    estimator = PerformanceEstimator()
    time = estimator.estimate_time(100, 600)
    print(f"é¢„ä¼°æ—¶é—´: {estimator.format_time(time)}")

def test_presets():
    """æµ‹è¯•é¢„è®¾"""
    from utils.config_presets import PresetManager
    
    for preset in PresetManager.get_all_presets():
        print(f"{preset.icon} {preset.name}: {preset.description}")

def test_notifications():
    """æµ‹è¯•é€šçŸ¥"""
    from utils.notifications import SystemNotifier
    
    SystemNotifier.notify("æµ‹è¯•", "è¿™æ˜¯ä¸€æ¡æµ‹è¯•é€šçŸ¥", "info")

if __name__ == '__main__':
    test_error_handler()
    test_performance()
    test_presets()
    test_notifications()
```

## ğŸš€ éƒ¨ç½²æ¸…å•

åœ¨éƒ¨ç½²å‰ç¡®ä¿ï¼š

- [ ] æ‰€æœ‰æ–°æ¨¡å—å·²æ·»åŠ åˆ°é¡¹ç›®
- [ ] requirements.txt åŒ…å« psutil
- [ ] é…ç½®æ–‡ä»¶åŒ…å«æ–°çš„é…ç½®é¡¹
- [ ] UI ç»„ä»¶å·²é›†æˆåˆ°ä¸»çª—å£
- [ ] é”™è¯¯å¤„ç†å·²åº”ç”¨åˆ°å…³é”®å‡½æ•°
- [ ] æ—¥å¿—ç³»ç»Ÿå·²æ›´æ–°
- [ ] æµ‹è¯•é€šè¿‡

## ğŸ“š ç›¸å…³æ–‡æ¡£

- [æ–°åŠŸèƒ½è¯´æ˜](æ–°åŠŸèƒ½è¯´æ˜.md) - è¯¦ç»†åŠŸèƒ½ä»‹ç»
- [ä½¿ç”¨è¯´æ˜](ä½¿ç”¨è¯´æ˜.md) - ç”¨æˆ·ä½¿ç”¨æŒ‡å—
- [æŠ€æœ¯è®¾è®¡](Technical_Design.md) - æŠ€æœ¯æ¶æ„

---

è¿”å› [é¡¹ç›®ä¸»é¡µ](../README.md)
