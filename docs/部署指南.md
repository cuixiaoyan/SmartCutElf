# SmartCutElf 部署指南

本文档介绍如何打包和部署 SmartCutElf 应用程序。

## 📋 准备工作

### 1. 安装打包工具

```bash
pip install pyinstaller
```

### 2. 检查依赖

确保所有依赖都已安装：

```bash
pip install -r requirements.txt
```

### 3. 测试应用

在打包前，确保应用程序能正常运行：

```bash
python main.py
```

## 🔨 打包步骤

### 方法一：使用打包脚本（推荐）

我们提供了自动化打包脚本 `build.py`，它会：
- 清理旧的构建文件
- 使用 PyInstaller 打包应用
- 创建便携版 ZIP 包
- 生成安装程序脚本

**运行打包脚本：**

```bash
python build.py
```

打包完成后，你会得到：
- `dist/SmartCutElf.exe` - 可执行文件
- `SmartCutElf_v1.0.0_Portable.zip` - 便携版压缩包
- `installer_script.iss` - Inno Setup 安装脚本

### 方法二：手动打包

如果需要自定义打包选项，可以手动使用 PyInstaller：

```bash
pyinstaller --name=SmartCutElf ^
    --windowed ^
    --onefile ^
    --clean ^
    --add-data="config.yaml;." ^
    --add-data="assets;assets" ^
    --hidden-import=PyQt5.QtMultimedia ^
    --hidden-import=PyQt5.QtMultimediaWidgets ^
    --icon=assets/app_icon.ico ^
    main.py
```

**注意：** 在 Linux/Mac 上，将 `;` 改为 `:`

## 📦 打包选项说明

### PyInstaller 参数

| 参数 | 说明 |
|------|------|
| `--name` | 可执行文件名称 |
| `--windowed` | 不显示控制台窗口（GUI 应用） |
| `--onefile` | 打包成单个可执行文件 |
| `--onedir` | 打包成文件夹（包含依赖） |
| `--clean` | 清理临时文件 |
| `--add-data` | 添加数据文件 |
| `--hidden-import` | 添加隐藏导入 |
| `--icon` | 设置应用图标 |

### 选择打包模式

**单文件模式 (`--onefile`)**
- ✅ 优点：分发方便，只有一个 exe 文件
- ❌ 缺点：启动稍慢，体积较大

**文件夹模式 (`--onedir`)**
- ✅ 优点：启动快，便于调试
- ❌ 缺点：需要分发整个文件夹

## 🎁 创建安装程序

### 使用 Inno Setup

1. **下载 Inno Setup**
   - 官网：https://jrsoftware.org/isinfo.php
   - 下载并安装 Inno Setup

2. **编译安装脚本**
   ```bash
   # 打包脚本会自动生成 installer_script.iss
   # 使用 Inno Setup 打开并编译
   ```

3. **生成安装程序**
   - 打开 `installer_script.iss`
   - 点击 "Build" -> "Compile"
   - 安装程序会生成在 `installer/` 目录

### 安装程序功能

- ✅ 自动安装到 Program Files
- ✅ 创建开始菜单快捷方式
- ✅ 可选创建桌面图标
- ✅ 自动卸载功能
- ✅ 中文界面支持

## 📤 分发方式

### 1. 便携版（推荐）

**优点：**
- 无需安装，解压即用
- 不修改系统注册表
- 方便在 U 盘上使用

**分发文件：**
```
SmartCutElf_v1.0.0_Portable.zip
├── SmartCutElf.exe
├── config.yaml
├── README.md
├── assets/
├── output/
├── logs/
└── cache/
```

### 2. 安装程序

**优点：**
- 专业的安装体验
- 自动创建快捷方式
- 便于卸载

**分发文件：**
```
SmartCutElf_Setup_v1.0.0.exe
```

### 3. 单文件版

**优点：**
- 最简单的分发方式
- 只有一个 exe 文件

**分发文件：**
```
SmartCutElf.exe
```

**注意：** 首次运行时需要在同目录下创建 `config.yaml`

## 🔧 依赖处理

### FFmpeg

SmartCutElf 依赖 FFmpeg 进行视频处理。有两种处理方式：

**方式一：要求用户安装**
- 在安装说明中提示用户安装 FFmpeg
- 提供 FFmpeg 下载链接和安装教程

**方式二：打包 FFmpeg**
```bash
# 将 FFmpeg 可执行文件添加到打包
pyinstaller --add-binary="ffmpeg.exe;." main.py
```

### Visual C++ Redistributable

Windows 用户可能需要安装 Visual C++ Redistributable：
- 下载：https://aka.ms/vs/17/release/vc_redist.x64.exe
- 可以在安装程序中自动检测并安装

## 🧪 测试打包结果

### 1. 基本功能测试

在干净的系统上测试：
- ✅ 应用能否正常启动
- ✅ 界面显示是否正常
- ✅ 能否加载视频文件
- ✅ 能否正常处理视频
- ✅ 配置文件读写是否正常

### 2. 兼容性测试

测试不同系统：
- Windows 10
- Windows 11
- 不同分辨率和 DPI 设置

### 3. 性能测试

- 启动时间
- 内存占用
- CPU 使用率
- 处理速度

## 📝 版本管理

### 版本号规则

使用语义化版本号：`主版本.次版本.修订号`

- **主版本**：不兼容的 API 修改
- **次版本**：向下兼容的功能性新增
- **修订号**：向下兼容的问题修正

### 更新版本号

需要更新的文件：
1. `config.yaml` - `app.version`
2. `build.py` - 版本号字符串
3. `installer_script.iss` - `AppVersion`
4. `README.md` - 版本说明

## 🚀 发布检查清单

发布前确认：

- [ ] 所有测试通过
- [ ] 版本号已更新
- [ ] README 已更新
- [ ] 更新日志已编写
- [ ] 打包文件已测试
- [ ] 安装程序已测试
- [ ] 文档已更新
- [ ] 已创建 Git 标签

## 📊 打包文件大小优化

### 减小体积的方法

1. **使用 UPX 压缩**
   ```bash
   pyinstaller --upx-dir=/path/to/upx main.py
   ```

2. **排除不必要的模块**
   ```bash
   pyinstaller --exclude-module=module_name main.py
   ```

3. **使用 onedir 模式**
   - 虽然文件夹较大，但可以删除不需要的 DLL

4. **优化依赖**
   - 只安装必需的包
   - 避免安装完整的 scipy、pandas 等大型库

## 🐛 常见问题

### 1. 打包后无法启动

**可能原因：**
- 缺少隐藏导入
- 数据文件路径错误
- 依赖库版本不兼容

**解决方法：**
```bash
# 添加隐藏导入
pyinstaller --hidden-import=missing_module main.py

# 查看详细错误
# 在命令行运行 exe 查看错误信息
```

### 2. 找不到配置文件

**解决方法：**
```python
# 在代码中使用正确的路径
import sys
from pathlib import Path

if getattr(sys, 'frozen', False):
    # 打包后的路径
    base_path = Path(sys._MEIPASS)
else:
    # 开发环境路径
    base_path = Path(__file__).parent
```

### 3. 视频处理失败

**可能原因：**
- FFmpeg 未正确打包或未安装
- 临时文件权限问题

**解决方法：**
- 确保 FFmpeg 在系统 PATH 中
- 或将 FFmpeg 打包到应用中

### 4. 杀毒软件误报

**解决方法：**
- 使用代码签名证书签名 exe
- 联系杀毒软件厂商添加白名单
- 提供源代码和构建说明

## 📚 参考资源

- [PyInstaller 官方文档](https://pyinstaller.org/)
- [Inno Setup 官方网站](https://jrsoftware.org/isinfo.php)
- [代码签名指南](https://docs.microsoft.com/en-us/windows/win32/seccrypto/cryptography-tools)

## 🆘 获取帮助

如果遇到打包问题：
1. 查看 PyInstaller 日志文件
2. 在命令行运行 exe 查看错误
3. 查阅官方文档
4. 在项目 Issues 中提问
